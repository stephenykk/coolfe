# 万法归宗——CGI

> 原文地址[万法归宗——CGI - 知乎](https://zhuanlan.zhihu.com/p/25013398)

> 遥想腾讯实习那年，了解到了 CGI，这种我以为只出现在教科书中，早就被扫进故纸堆的技术竟然还在鹅厂盛行着。一时纠结：我本想来大厂学习新技术，没想到却来这里考古。不过后来我和自己和解了，虽然 CGI 早被业界主流淘汰，但通过学习它，可以加深 WebServer 通信、HTTP 协议的深层认识，也算有所收获。

CGI 即 **Common Gateway Interface**，译作“**通用网关接口**”。初次听闻，略感疑惑，实则每个字眼都值得玩味。

## 1\. Common

**通用**，是一个显著特征。虽然我们听说过 Java 的 Servlet，Python 的 WSGI。但其实 Java、Python 都是支持 CGI 的，不仅如此，其他我们所熟知的语言大都也都支持。理论上来说，所有支持标准输出，支持获取环境变量的编程语言都能用来编写 CGI 程序。

在 HTML 诞生之后，随着网络规模的发展，动态网站成为人们的主要诉求。彼时，CGI 应运而生。第一个版本的 CGI 由 Perl 语言编写的脚本，因此通常称之为“CGI 脚本”。直至今日，把 CGI 一词丢入谷歌的搜索框，搜到的一大把都是 Perl 相关的内容。

_其实呢，脚本(script)并不一定就是脚本语言编写的。脚本描述的是一类程序的特征：为了完成某一任务，用程序实现批量执行一组常用逻辑的组合。凡是符合这一特征的程序都可称作脚本。当然，时至今日，脚本语言所编写的程序都可以称之为脚本程序，并且其内部逻辑也早已变得并不简单。_

如今呢，上古巫术 Perl 早已淡出人们视野，CGI 这技术虽然通用，但是实则真正仍在应用的恐怕只有 C/C++了。

## 2\. Gateway

**网关**，网关。各位看官，不用好奇，不用疑惑。随便打开一本 HTTP 的书，都会提到网关的概念。通常意识中，网关一词更多的是硬件层面的概念，但其实与 CGI 的网关二字之含义也是不谋而合的。称 CGI 为软件网关也不为过。

网关，更形象的叫法是“**协议翻译机**”。通常与网关输入输出两端通信使用的是不同的协议。即一方是 HTTP 协议，另一方可能是其他协议，比如企业内部的自定义协议。CGI 程序既是如此。

![](https://pic1.zhimg.com/v2-146dd92968211c1f8ae96ad4178fa66c_r.jpg)

（费力画了蛮久）

CGI 程序通常部署到 Web 服务器（如 Apache）上，Web 服务器然后调用 CGI 程序，关于 CGI 程序到底如何从 Web 服务器中获得输入，请继续阅读下一节 Interface。

请注意区分 Web Server 和后台 Server。

## 3\. Interface

_**Interface**：Come On。又是一个被国人翻译烂掉的词汇。API（应用程序接口）的 I 是它，被译作“接口”。UI（用户界面）的 I 也是它，被译作“界面”。实际他们是同样的意思。我更喜欢“接口”一词。_

## 3.1 接口协议

**接口**，确切而言是“接口协议”，熟悉网络的同学们，肯定都明白“**协议**”是什么。所谓协议，既是通信双方或多方都共识并遵守的一套规则。就像红灯停，绿灯行，上下车道靠右行。只有全国人民都遵守这个规则，交通才不会出什么乱子。实际上规定绿灯停，红灯行，上下车道靠左行可不可以呢？当然可以，英国日本都是靠左行的，关键是全国人民的认知要一致，这个**共识**很重要。

举几个栗子：TCP/IP 这类二进制协议，协议内容的描述是某某字节是干嘛滴，其取值范围是什么，不同取值又是什么含义。HTTP 协议是字符协议，这类协议内容的描述就是第一行是啥，第二行是啥……，应该出现啥单词，表示啥意思。

其实不管是 TCP/IP 或是 HTTP，都可以统称为“网络协议”，粗浅一点理解就是“**描述报文内容详细语义的协议**”。而“接口协议”却不然，他不会定义哪些字节该写什么，也不会定义字符的内容规范。CGI 其实是构架在 HTTP 协议之上的。它描述的是**另一个维度的共识标准**。

## 3.2 输入，输出

回顾上一节的图。Web 服务器在接收到用户浏览器的 HTTP 请求，比如请求如下 URL：

```text
http://guodongxiaren.me/cgi-bin/helloworld.cgi
```

此时在 Web 服务器调用 helloworld.cgi 之前，会把各类 HTTP 请求中的信息以**环境变量**的方式写入 OS。CGI 程序本质是 OS 上一个普通的可执行程序，它通过语言本身库函数来获取环境变量，从而获得数据输入。

除环境变量外，另外一个 CGI 程序获取数据的方式就是**标准输入（stdin）**。如 post 请求一个 CGI 的 URL，那么 POST 的数据，CGI 是通过标准输入来获取到的。

而 CGI 如何构造出数据（比如 HTML 页面）返回给浏览器呢？其实 CGI 本身只要向标准输出去写入数据即可。比如 printf、cout，比如 System.out.println，又比如 print、echo 等。因为 Web 服务器已经做了重定向，将标准输出重定向给 Web 服务器的与浏览器连接的 socket。

此时要注意的是，不要以为返回 HTML 页面，那么直接输出一段 HTML 代码就 OK，注意。此时 CGI 的输出承担的是 HTTP 协议的响应部分，因此 HTTP 响应报头也要自己标准输出出来。比如：

```cpp
cout<<"Content-Type:text/html\n\n"<<endl;
```

注意最后要有两个换行符啊。不要问为什么。因为 HTTP 协议本身就是一个字符协议。它需要通过一个空行来区分哪里是报头，哪里是实体。在两个换行符（即一个空行）之后就可以愉快的输出 HTML（即实体部分）了。熟悉 PHP 的同学，肯定 echo 过 HTML 代码，没错，这很像。

CGI 编写 Web 程序虽然看似解析组装等操作十分繁琐，但其实都有很多第三方的封装来简化这些操作，高级语言的标准库基本都已经做了封装，而针对 C++则有一个还不错的第三方库 Cgicc。

## 4\. 硬伤

既然有这么多现成的库做了封装，那么理应用 CGI 编写 Web 的也不少才对。其实不然，**这是因为 CGI 有一大硬伤：**

每次 HTTP 请求 CGI，Web 服务器都有启动一个新的进程去执行这个 CGI 程序，即颇具 Unix 特色的 fork-and-execute。当用户请求量大的时候，这个 fork-and-execute 的操作会严重拖慢 Web 服务器的性能。

时势造英雄，FastCGI（简称 FCGI）技术应运而生。简单来说，其本质就是一个常驻内存的进程池技术，由调度器负责将传递过来的 CGI 请求发送给处理 CGI 的 handler 进程来处理。在一个请求处理完成之后，该处理进程不销毁，继续等待下一个请求的到来。

当然 FCGI 其实也并不是什么惊世骇俗的创意，很容易联想到的解决思路。**资源池是后台性能优化中的常见套路**。Java 发明的 Servlet 技术也是一种常驻内存的网关通信技术，只不过它采用的是多线程而非进程。

## 5\. 争议

CGI 程序有一不大不小的缺陷，缺乏 URL 路由的功能，基本上一个 CGI 都是独立提供给外界访问，一个 CGI 就是独立的可执行程序。因此\*\*不仅 CGI 的 URL 比较丑陋，而且容易暴露真实路径\*\*。

CGI 一般只做上层目录的路由，而这只能交给 Web 服务器去配置。比如：[http://app/hello.cgi](http://app/hello.cgi) 的 app 目录在物理 OS 的什么位置可通过 Apache 去配置。虽然理论上讲 CGI 程序也可以实现[http://app/hello.cgi](http://app/hello.cgi)/abc/def 这种形式的路由。但是基本上没人这样做。

## 6\. 展望

我们知道，CGI 可以直接吐出一个 html 网页，也可以进行各种计算、逻辑处理任务。但随着各类 web 前后端技术的发展，以及大数据、高并发的 Server 使用场景越来越多。现代的 CGI 的用法，在发生变化。越来越多的任务从后端转移到前端，前端页面利用强大的 JS 承担起更多的责任。

CGI 一般不再用于直接返回 html 页面，同时将复杂的计算、IO 任务下沉到后端（后端可以进一步进行路由转发，实现负载均衡）。使 CGI 作为前后端之间的中间层。彼时 CGI 的职能是完成基本的**鉴权**以及**数据交换。**

Restful 风格 API 的出现，让 CGI 获得了**续命**。CGI 解析前端请求，再转发给对应后端；然后从后端取回数据，给前端返回 XML 或 JSON。然后前端 JS 利用 XML/JSON 中的数据来进行填充。可以绘制出丰富的界面或用作他用。JS 可以使用 Ajax 技术来向后台 CGI 发起数据请求。Ajax 完成的是不需要刷新整个页面就可以加载后端数据（比如从数据库中取出）。

_当然实际工程应用中很少严格遵守 Restful 的学院派定义，比如 URL 资源使用名词，然后使用各个 HTTP 的方法（GET、POST、PUT、DELETE 等）表示动词。_

除了 FCGI 外，还有 SCGI（Simple CGI），也是作为 CGI 的替代协议而产生的，但他与 FCGI 更像，另外呢，SCGI 在每次完成 HTTP 应答之后都立即关闭 HTTP 连接，有点张小龙“**用完即走**”的意思。这个简单的协议更符合 Restful API 的理念需要。但是名气不大哈。

## 7\. 万法归宗

CGI 三个单词，我个人认为核心点在 G（Gateway，网关）上面。在了解了 CGI 的基础知识之后，你会发现其他语言中都有类似概念，比如 Servlet、WSGI。这些概念其实都滥觞于 CGI，但是又完成了各自的进化。后续专栏文章会带你走进 Servlet 以及 WSGI 等内容。

---

## 推荐阅读

由于工作后写作时间有限，写作更偏向于意识流。因此关于 CGI 的 API 以及编程细节，可以阅读我大学期间在 CSDN 上写的一篇文章《[古老的 CGI 与 Web 开发](http://blog.csdn.net/guodongxiaren/article/details/50569675)》。当然了，**内容其实也并不完备，当初计划写系列，后来还是烂尾。**期待本专栏可以坚持下来吧。

欢迎关注我的知乎专栏——《后台公论》：
