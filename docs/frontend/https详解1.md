# HTTPS 详解一：附带最精美详尽的 HTTPS 原理图

如此精美的图搭配这么详细的过程解析，你再搞不懂就说不过去了

[HTTPS 详解一：附带最精美详尽的 HTTPS 原理图](https://segmentfault.com/a/1190000021494676)
[HTTPS详解二：SSL / TLS 工作原理和详细握手过程](https://segmentfault.com/a/1190000021559557?_ea=29659396)

---

> 我在前端页面对敏感数据进行加密不就行了，比如 MD5 加盐加密。这么想就太简单了。首先 MD5 并不是加密算法，其全称是 Message Digest Algorithm MD5，意为信息摘要算法，是一种不可逆的哈希算法，也就是说经过前端 MD5 处理过的数据在服务器端是无法复原的。这里以密码举例，前端把用户密码通过 MD5 进行处理，并把得到的哈希值发送给服务器，服务器由于无法复原密码，就会直接用这个哈希值处理用户请求。所以第三方在获取这个哈希值后，可以绕过前端登录页面直接访问服务器，造成安全问题。

http通信的风险

- 窃听
- 纂改
- 冒充

https如何规避这些风险：

- 防窃听 --> 加密 (混合加密，非对称加密交换密钥 如: RSA/对称加密传输数据 AES 密钥是客户端和服务端各自根据约定的加密算法生成，用公钥加密，传送到服务端)
- 防纂改 --> 摘要算法 如： MD5 (先对原文进行摘要算法，然后再加密传输)
- 防冒充 --> 数字证书 (证明服务器的真实性, 包含：公钥 域名 有效期 公司信息 颁发者 ) 

可见HTTPS 并非独立的通信协议，而是对 HTTP 的扩展，保证了通信安全，二者关系如下

![HTTPS = HTTP + SSL / TLS](https://segmentfault.com/img/bVbClUj)

数字证书

- 颁发 CA用私钥对证书申请信息进行签名，证书申请信息包括：公钥 域名 公司 有效期
- 验证 浏览器用CA公钥解密，解密失败或不认识CA或当前域名和证书域名不符则提示HTTPS告警，成功则 取出服务器公钥

HTTPS 的整个通信过程可以分为两大阶段：
- 证书验证
- 数据传输阶段，数据传输阶段又可以分为：非对称加密 和 对称加密 两个阶段。

> SSL 和 TLS 协议可以为通信双方提供识别和认证通道，从而保证通信的机密性和数据完整性。TLS 协议是从Netscape SSL 3.0协议演变而来的，不过这两种协议并不兼容，SSL 已经逐渐被 TLS 取代

> TLS 握手是启动 HTTPS 通信的过程，类似于 TCP 建立连接时的三次握手

![TLS握手过程](https://segmentfault.com/img/bVbCCMD)

经历5次握手：
- 发起Https连接请求 client hello , 附带 client random + TLS版本 + 支持的加密算法
- 响应https连接请求 server hello , 附带 server random + 证书 + 选择的加密算法
- 验证证书，取出公钥，生成随机串 premaster secret, 用公钥加密 premaster secret 发送给服务端，用约定的算法基于 client random , server random 和 premaster secret 生成密钥；服务端解密得到premaster secrect, 用约定的算法基于 client random , server random 和 premaster secret 生成密钥
- 客户端发送 finished 消息
- 服务端也响应 finished 消息

至此，TLS握手完成，客户端和服务端基于相同的密钥，进行对称加密通信

中间人攻击

在非对称加密通信过程中，服务器需要将公钥发送给客户端，在这一过程中，公钥很可能会被第三方拦截并替换，然后这个**第三方就可以冒充服务器与客户端进行通信**，这就是传说中的“中间人攻击”(man in the middle attack)。

解决方法  
就是服务器不直接向客户端发送公钥，而是要求受信任的第三方，也就是证书认证机构 (Certificate Authority, 简称 CA)将公钥合并到数字证书中，CA用自己的私钥进行数字签名(*信用背书*)

证书链，也称为证书路径，是用于认证实体合法身份的证书列表

> 证书链从根证书开始，并且证书链中的每一级证书所标识的实体都要为其下一级证书签名，而根证书自身则由证书颁发机构签名。
